name: AI Auto Fix System

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-issues:
    name: 問題検出
    runs-on: ubuntu-latest
    outputs:
      has_lint_errors: ${{ steps.detect.outputs.lint_errors }}
      has_format_errors: ${{ steps.detect.outputs.format_errors }}
      has_css_errors: ${{ steps.detect.outputs.css_errors }}
      has_test_failures: ${{ steps.detect.outputs.test_failures }}
      has_conflicts: ${{ steps.detect.outputs.conflicts }}
      has_server_errors: ${{ steps.detect.outputs.server_errors }}
      gemini_high_priority: ${{ steps.gemini-check.outputs.gemini_high }}
      should_run_fix: ${{ steps.decision.outputs.should_run }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        continue-on-error: true

      - name: Detect Issues
        id: detect
        continue-on-error: true
        run: |
          echo "検出された問題を確認中..."

          # ESLint check
          echo "## ESLint Check" > lint.log
          if ! pnpm lint >> lint.log 2>&1; then
            echo "lint_errors=true" >> $GITHUB_OUTPUT
            echo "警告: Lintエラーが検出されました"
          fi

          # Format check
          echo "## Format Check" > format.log
          if ! pnpm format:check >> format.log 2>&1; then
            echo "format_errors=true" >> $GITHUB_OUTPUT
            echo "警告: フォーマットエラーが検出されました"
          fi

          # CSS check
          echo "## CSS Check" > css.log
          if ! pnpm lint:css >> css.log 2>&1; then
            echo "css_errors=true" >> $GITHUB_OUTPUT
            echo "警告: CSSエラーが検出されました"
          fi

          # Test check
          echo "## Test Check" > test.log
          if ! pnpm test >> test.log 2>&1; then
            echo "test_failures=true" >> $GITHUB_OUTPUT
            echo "警告: テスト失敗が検出されました"
          fi

          # Server health check
          echo "## Server Health Check" > server.log
          timeout 15s pnpm start &
          sleep 8
          if ! curl -f http://localhost:3333/health >> server.log 2>&1; then
            echo "server_errors=true" >> $GITHUB_OUTPUT
            echo "警告: サーバー起動エラーが検出されました"
          fi
          pkill -f "node server.js" || true

          # Conflict check
          echo "## Conflict Check" > conflict.log
          git fetch origin ${{ github.base_ref }}
          BASE_SHA=$(git merge-base HEAD origin/${{ github.base_ref }})
          if git merge-tree $BASE_SHA HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "conflicts=true" >> $GITHUB_OUTPUT
            echo "警告: マージコンフリクトが検出されました"
          fi

      - name: Check Gemini Review Priority
        id: gemini-check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const reviews = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              const geminiReview = reviews.data.find(r =>
                r.user.login.toLowerCase().includes('gemini') ||
                r.body.toLowerCase().includes('gemini')
              );

              if (geminiReview) {
                console.log('確認: Geminiレビューが見つかりました');

                // Priority High チェック
                if (/priority:?\s*high/i.test(geminiReview.body)) {
                  core.setOutput('gemini_high', 'true');
                  console.log('重要: 優先度の高い問題が見つかりました');
                }

                // レビューコメントを保存
                const fs = require('fs');
                fs.writeFileSync('gemini_review.txt', geminiReview.body);
              }
            } catch (error) {
              console.log('情報: レビューがまだありません または エラー:', error.message);
            }

      - name: Decide if fix is needed
        id: decision
        run: |
          if [ "${{ steps.detect.outputs.lint_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.format_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.css_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.test_failures }}" = "true" ] || \
             [ "${{ steps.detect.outputs.server_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.conflicts }}" = "true" ] || \
             [ "${{ steps.gemini-check.outputs.gemini_high }}" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "自動修正が必要です"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "確認: 問題は検出されませんでした"
          fi

      - name: Upload Logs
        if: steps.decision.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: issue-logs
          path: |
            lint.log
            format.log
            css.log
            test.log
            server.log
            conflict.log
            gemini_review.txt
          retention-days: 7

  auto-fix-simple:
    name: 簡単な修正（Lint/Format/CSS）
    needs: detect-issues
    if: |
      needs.detect-issues.outputs.should_run_fix == 'true' &&
      (needs.detect-issues.outputs.has_lint_errors == 'true' ||
       needs.detect-issues.outputs.has_format_errors == 'true' ||
       needs.detect-issues.outputs.has_css_errors == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Auto-fix Lint, Format, and CSS
        run: |
          echo "自動修正を実行中..."
          pnpm lint:fix || true
          pnpm format || true
          pnpm lint:css:fix || true

      - name: Commit fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "自動修正: Lint、Format、CSSの修正"
            git push
            echo "確認: Lint/Format/CSS修正がコミットされました"
          else
            echo "情報: コミットする変更がありません"
          fi

  ai-fix-complex:
    name: AI修正（Claude Code）
    needs: [detect-issues, auto-fix-simple]
    if: |
      always() &&
      needs.detect-issues.outputs.should_run_fix == 'true' &&
      (needs.detect-issues.outputs.has_test_failures == 'true' ||
       needs.detect-issues.outputs.has_server_errors == 'true' ||
       needs.detect-issues.outputs.has_conflicts == 'true' ||
       needs.detect-issues.outputs.gemini_high_priority == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Download Logs
        uses: actions/download-artifact@v4
        with:
          name: issue-logs
        continue-on-error: true

      - name: Prepare Context Files
        id: context
        run: |
          echo "コンテキストを収集中..."

          # エラーログの内容を環境変数に保存
          LINT_LOG=$(cat lint.log 2>/dev/null || echo 'なし')
          FORMAT_LOG=$(cat format.log 2>/dev/null || echo 'なし')
          CSS_LOG=$(cat css.log 2>/dev/null || echo 'なし')
          TEST_LOG=$(cat test.log 2>/dev/null || echo 'なし')
          SERVER_LOG=$(cat server.log 2>/dev/null || echo 'なし')
          CONFLICT_LOG=$(cat conflict.log 2>/dev/null || echo 'なし')
          GEMINI_COMMENTS=$(cat gemini_review.txt 2>/dev/null || echo 'なし')

          # コンテキストファイルを作成
          cat > ai_context.md << EOF
          # 検出された問題

          ## ESLint Errors
          \`\`\`
          $LINT_LOG
          \`\`\`

          ## Format Errors
          \`\`\`
          $FORMAT_LOG
          \`\`\`

          ## CSS Errors
          \`\`\`
          $CSS_LOG
          \`\`\`

          ## Test Failures
          \`\`\`
          $TEST_LOG
          \`\`\`

          ## Server Errors
          \`\`\`
          $SERVER_LOG
          \`\`\`

          ## Merge Conflicts
          \`\`\`
          $CONFLICT_LOG
          \`\`\`

          ## Gemini Review Comments
          $GEMINI_COMMENTS
          EOF

          echo "コンテキストの収集が完了しました"

      - name: AI Analysis and Fix with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: 30
          prompt: |
            あなたは経験豊富な日本のフルスタックエンジニアです。このPRで検出された問題を分析し、修正してください。

            ## 技術スタック
            - Node.js + Express.js
            - Vanilla JavaScript（TypeScriptは使用していません）
            - Vercelサーバーレス関数
            - Axios, Cheerio, OpenAI API
            - ESLint, Prettier, Stylelint
            - Vitest（テストフレームワーク）

            ## 検出された問題
            ai_context.md ファイルを読んで、検出された問題を確認してください。

            ## 修正の原則
            1. CI/CDテスト合格が最優先
            2. サーバー起動エラーは必ず解消
            3. マージ可能な状態にする
            4. 既存のコードスタイル・アーキテクチャを維持
            5. 不確実な修正は別Issueに切り出す（gh issue createを使用）
            6. Gemini Priority Highは優先対応

            ## タスク
            1. ai_context.md を読んで問題を把握
            2. 関連するソースファイルを読んで原因を特定
            3. 問題を修正（Editツールを使用）
            4. 修正後、pnpm test と pnpm lint で検証
            5. 修正内容をPRにコメント（gh pr comment を使用）

            ## 重要
            - 日本語でコメントしてください
            - 修正が完了したら、何を修正したかの要約をPRにコメントしてください
            - 不確実な修正や後で対応すべき問題は gh issue create で別Issueを作成してください

          claude_args: '--allowed-tools "Bash(pnpm:*),Bash(npm:*),Bash(gh issue create:*),Bash(gh pr comment:*),Bash(cat:*),Bash(ls:*),Bash(git:*),Read,Edit,Write,Glob,Grep"'
