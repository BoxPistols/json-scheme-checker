const OpenAI = require('openai');

const EMPLOYER_PROMPT = `ã‚ãªãŸã¯æ±‚äººç¥¨ä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®JobPosting JSON-LDãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ¡ç”¨å´å‘ã‘ã®æ”¹å–„ææ¡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€åˆ†æè¦³ç‚¹ã€‘
1. æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã®é­…åŠ›åº¦ã¨æ¤œç´¢ã•ã‚Œã‚„ã™ã•
2. è·å‹™å†…å®¹ã®å…·ä½“æ€§ã¨èª¬å¾—åŠ›
3. å¿…é ˆã‚¹ã‚­ãƒ«ãƒ»æ­“è¿ã‚¹ã‚­ãƒ«ã®æ˜ç¢ºã•
4. çµ¦ä¸ãƒ¬ãƒ³ã‚¸ã®å¦¥å½“æ€§ã¨ç«¶äº‰åŠ›
5. ç¦åˆ©åšç”Ÿãƒ»ä¼æ¥­æ–‡åŒ–ã®ã‚¢ãƒ”ãƒ¼ãƒ«
6. å¿œå‹Ÿã®ãƒãƒ¼ãƒ‰ãƒ«ã®é©åˆ‡ã•
7. SEOå¯¾ç­–ï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®å……å®Ÿåº¦ï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã§æ—¥æœ¬èªã®Markdownå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

## ğŸ“Š ç·åˆè©•ä¾¡
â˜…â˜…â˜…â˜…â˜† (5æ®µéšè©•ä¾¡)

[100æ–‡å­—ç¨‹åº¦ã®ç·è©•]

## ğŸ¯ æ”¹å–„ææ¡ˆ

### 1. ã‚¿ã‚¤ãƒˆãƒ«
**ç¾çŠ¶:** [ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«]
**å•é¡Œç‚¹:** [å…·ä½“çš„ãªå•é¡Œ]
**æ”¹å–„æ¡ˆ:** [å…·ä½“çš„ãªææ¡ˆ]

### 2. è·å‹™å†…å®¹
**ç¾çŠ¶:** [ç¾åœ¨ã®è¨˜è¿°]
**å•é¡Œç‚¹:** [å…·ä½“çš„ãªå•é¡Œ]
**æ”¹å–„æ¡ˆ:** [å…·ä½“çš„ãªææ¡ˆ]

### 3. ã‚¹ã‚­ãƒ«è¦ä»¶
**ç¾çŠ¶:** [ç¾åœ¨ã®è¦ä»¶]
**å•é¡Œç‚¹:** [å…·ä½“çš„ãªå•é¡Œ]
**æ”¹å–„æ¡ˆ:** [å…·ä½“çš„ãªææ¡ˆ]

### 4. å¾…é‡æ¡ä»¶
**ç¾çŠ¶:** [ç¾åœ¨ã®è¨˜è¿°]
**å•é¡Œç‚¹:** [å…·ä½“çš„ãªå•é¡Œ]
**æ”¹å–„æ¡ˆ:** [å…·ä½“çš„ãªææ¡ˆ]

## ğŸ’¡ è¿½åŠ æ¨å¥¨äº‹é …
- [å…·ä½“çš„ãªè¿½åŠ ææ¡ˆ1]
- [å…·ä½“çš„ãªè¿½åŠ ææ¡ˆ2]
- [å…·ä½“çš„ãªè¿½åŠ ææ¡ˆ3]

## âš ï¸ æ³¨æ„ç‚¹
[æ³•çš„æ³¨æ„ç‚¹ã‚„é¿ã‘ã‚‹ã¹ãè¡¨ç¾ãªã©]`;

const APPLICANT_PROMPT = `ã‚ãªãŸã¯ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®JobPosting JSON-LDãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€å¿œå‹Ÿè€…å‘ã‘ã®é¢æ¥å¯¾ç­–ã¨è¦ä»¶åˆ†æã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€åˆ†æè¦³ç‚¹ã€‘
1. æ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã¨çµŒé¨“ãƒ¬ãƒ™ãƒ«
2. ä¼æ¥­æ–‡åŒ–ãƒ»åƒãæ–¹ã®æ¨æ¸¬
3. çµ¦ä¸ãƒ¬ãƒ³ã‚¸ã‹ã‚‰è¦‹ã‚‹å¸‚å ´ä¾¡å€¤
4. é¢æ¥ã§è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆ
5. ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã¹ãçµŒé¨“ãƒ»ã‚¹ã‚­ãƒ«
6. æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„ç‚¹

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã§æ—¥æœ¬èªã®Markdownå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

## ğŸ¯ æ±‚äººè¦ä»¶åˆ†æ

### å¿…é ˆã‚¹ã‚­ãƒ«
- [ã‚¹ã‚­ãƒ«1]: [é‡è¦åº¦ã¨ç†ç”±]
- [ã‚¹ã‚­ãƒ«2]: [é‡è¦åº¦ã¨ç†ç”±]
- [ã‚¹ã‚­ãƒ«3]: [é‡è¦åº¦ã¨ç†ç”±]

### æ­“è¿ã‚¹ã‚­ãƒ«
- [ã‚¹ã‚­ãƒ«1]: [å„ªä½æ€§]
- [ã‚¹ã‚­ãƒ«2]: [å„ªä½æ€§]

### çµŒé¨“ãƒ¬ãƒ™ãƒ«
[æ¨å®šã•ã‚Œã‚‹çµŒé¨“å¹´æ•°ã¨æ ¹æ‹ ]

## ğŸ¢ ä¼æ¥­ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ†æ

### ä¼æ¥­æ–‡åŒ–ã®æ¨æ¸¬
[æ±‚äººå†…å®¹ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ä¼æ¥­æ–‡åŒ–]

### åƒãæ–¹ã®ç‰¹å¾´
[ãƒªãƒ¢ãƒ¼ãƒˆã€å‹¤å‹™æ™‚é–“ã€ãƒãƒ¼ãƒ æ§‹æˆãªã©]

### çµ¦ä¸ãƒ¬ãƒ³ã‚¸ã®è©•ä¾¡
[å¸‚å ´ä¾¡å€¤ã¨ã®æ¯”è¼ƒã¨å¦¥å½“æ€§]

## ğŸ“ é¢æ¥å¯¾ç­–

### æƒ³å®šè³ªå•ãƒªã‚¹ãƒˆ
1. **[è³ªå•]**
   - æ„å›³: [ãªãœã“ã®è³ªå•ã‚’ã™ã‚‹ã‹]
   - å›ç­”ã®ãƒã‚¤ãƒ³ãƒˆ: [ã©ã†ç­”ãˆã‚‹ã¹ãã‹]

2. **[è³ªå•]**
   - æ„å›³: [ãªãœã“ã®è³ªå•ã‚’ã™ã‚‹ã‹]
   - å›ç­”ã®ãƒã‚¤ãƒ³ãƒˆ: [ã©ã†ç­”ãˆã‚‹ã¹ãã‹]

3. **[è³ªå•]**
   - æ„å›³: [ãªãœã“ã®è³ªå•ã‚’ã™ã‚‹ã‹]
   - å›ç­”ã®ãƒã‚¤ãƒ³ãƒˆ: [ã©ã†ç­”ãˆã‚‹ã¹ãã‹]

### é€†è³ªå•ã®ä¾‹
- [è³ªå•1]: [ã“ã®è³ªå•ã‚’ã™ã‚‹æ„å›³]
- [è³ªå•2]: [ã“ã®è³ªå•ã‚’ã™ã‚‹æ„å›³]
- [è³ªå•3]: [ã“ã®è³ªå•ã‚’ã™ã‚‹æ„å›³]

## ğŸ’ª ã‚¢ãƒ”ãƒ¼ãƒ«æˆ¦ç•¥

### å¼·èª¿ã™ã¹ããƒã‚¤ãƒ³ãƒˆ
1. [ãƒã‚¤ãƒ³ãƒˆ1ã¨å…·ä½“çš„ãªã‚¢ãƒ”ãƒ¼ãƒ«æ–¹æ³•]
2. [ãƒã‚¤ãƒ³ãƒˆ2ã¨å…·ä½“çš„ãªã‚¢ãƒ”ãƒ¼ãƒ«æ–¹æ³•]
3. [ãƒã‚¤ãƒ³ãƒˆ3ã¨å…·ä½“çš„ãªã‚¢ãƒ”ãƒ¼ãƒ«æ–¹æ³•]

### æº–å‚™ã™ã¹ãå®Ÿç¸¾
- [å®Ÿç¸¾ã®ç¨®é¡1]: [ã©ã†æº–å‚™ã™ã‚‹ã‹]
- [å®Ÿç¸¾ã®ç¨®é¡2]: [ã©ã†æº–å‚™ã™ã‚‹ã‹]

## âš ï¸ æ³¨æ„äº‹é …ã¨ãƒªã‚¹ã‚¯
[å¿œå‹Ÿå‰ã«ç¢ºèªã™ã¹ãã“ã¨ã€æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯]`;

module.exports = async (req, res) => {
  // CORSãƒ˜ãƒƒãƒ€ãƒ¼
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { jobPosting, mode } = req.body;

    if (!jobPosting) {
      return res.status(400).json({ error: 'jobPosting is required' });
    }

    if (!mode || !['employer', 'applicant'].includes(mode)) {
      return res.status(400).json({ error: 'mode must be "employer" or "applicant"' });
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return res.status(500).json({ error: 'OpenAI API key not configured' });
    }

    const openai = new OpenAI({ apiKey });

    const systemPrompt = mode === 'employer' ? EMPLOYER_PROMPT : APPLICANT_PROMPT;
    const userContent = JSON.stringify(jobPosting, null, 2);

    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    const stream = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userContent },
      ],
      stream: true,
      temperature: 0.7,
    });

    for await (const chunk of stream) {
      const content = chunk.choices[0]?.delta?.content;
      if (content) {
        res.write(`data: ${JSON.stringify({ content })}\n\n`);
      }
    }

    res.write('data: [DONE]\n\n');
    res.end();
  } catch (error) {
    console.error('Advisor API error:', error.message);

    if (!res.headersSent) {
      return res.status(500).json({
        error: 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ',
        details: error.message,
      });
    }

    res.write(`data: ${JSON.stringify({ error: error.message })}\n\n`);
    res.end();
  }
};
