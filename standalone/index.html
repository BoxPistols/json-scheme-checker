<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-LD Schema Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .input-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        input[type="url"] {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        input[type="url"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        button {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            color: white;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sample-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sample-links span {
            color: #64748b;
            font-size: 14px;
        }

        .sample-link {
            padding: 6px 12px;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 14px;
            color: #3b82f6;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }

        .sample-link:hover {
            background: #e2e8f0;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .schema-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .schema-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .schema-type {
            display: inline-block;
            padding: 4px 12px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .schema-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 2px;
            border-radius: 4px;
        }

        .view-toggle button {
            padding: 6px 12px;
            font-size: 13px;
            background: transparent;
            color: #64748b;
            min-width: 70px;
        }

        .view-toggle button.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .schema-index {
            color: #94a3b8;
            font-size: 14px;
        }

        .schema-content {
            padding: 20px;
        }

        /* Table View Styles */
        .table-view {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .property-name {
            font-weight: 500;
            color: #1e40af;
        }

        .property-value {
            color: #334155;
        }

        .property-type {
            display: inline-block;
            padding: 2px 6px;
            background: #f1f5f9;
            border-radius: 3px;
            font-size: 11px;
            color: #64748b;
            margin-left: 8px;
            font-weight: normal;
        }

        /* List View for Arrays */
        .array-list {
            background: #f8fafc;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
        }

        .array-list-item {
            background: white;
            padding: 10px;
            margin: 6px 0;
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
        }

        .nested-object {
            margin-left: 20px;
            padding-left: 16px;
            border-left: 2px solid #e2e8f0;
        }

        /* JSON View Styles */
        .json-view {
            background: #1e293b;
            border-radius: 6px;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #cbd5e1;
        }

        .json-view.hidden {
            display: none;
        }

        .table-view.hidden {
            display: none;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        .json-null {
            color: #94a3b8;
        }

        .json-bracket {
            color: #cbd5e1;
        }

        .copy-button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #475569;
        }

        .copy-button:hover {
            background: #f8fafc;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .copy-button.copied {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 16px;
            color: #dc2626;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            color: #64748b;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 20px;
            color: #1e293b;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-data h3 {
            color: #475569;
            margin: 16px 0 8px;
        }

        /* Expand/Collapse for nested objects */
        .expandable {
            cursor: pointer;
            user-select: none;
        }

        .expandable::before {
            content: '▼';
            display: inline-block;
            margin-right: 6px;
            transition: transform 0.2s;
            font-size: 10px;
        }

        .expandable.collapsed::before {
            content: '▶';
        }

        .nested-content {
            display: block;
            margin-top: 8px;
        }

        .nested-content.collapsed {
            display: none;
        }

        /* URL value styling */
        .url-value {
            color: #3b82f6;
            text-decoration: none;
            word-break: break-all;
        }

        .url-value:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>JSON-LD Schema Viewer</h1>
            <p class="subtitle">WebサイトのJSON-LD構造化データを可視化</p>
        </header>

        <div class="input-section">
            <div class="input-group">
                <input
                    type="url"
                    id="urlInput"
                    placeholder="URLを入力してください (例: https://example.com)"
                    value=""
                >
                <button id="fetchButton" onclick="fetchAndDisplay()">
                    取得
                </button>
            </div>

            <div class="sample-links">
                <span>サンプル:</span>
                <a class="sample-link" onclick="loadSample('https://www.google.com')">Google</a>
                <a class="sample-link" onclick="loadSample('https://www.wikipedia.org')">Wikipedia</a>
                <a class="sample-link" onclick="loadSample('https://www.github.com')">GitHub</a>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>データを取得中...</p>
        </div>

        <div class="results-section" id="results">
            <div class="stats" id="stats"></div>
            <div id="schemasContainer"></div>
        </div>
    </div>

    <script>
        // CORSプロキシサービス（開発用）
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

        function loadSample(url) {
            document.getElementById('urlInput').value = url;
            fetchAndDisplay();
        }

        async function fetchAndDisplay() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showError('URLを入力してください');
                return;
            }

            if (!isValidUrl(url)) {
                showError('有効なURLを入力してください');
                return;
            }

            showLoading(true);
            hideError();
            hideResults();

            try {
                let response;

                // localhostの場合は直接アクセス、それ以外はCORSプロキシを使用
                if (url.includes('localhost') || url.includes('127.0.0.1') || url.includes('[::1]')) {
                    response = await fetch(url);
                } else {
                    const proxyUrl = CORS_PROXY + encodeURIComponent(url);
                    response = await fetch(proxyUrl);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const html = await response.text();
                const schemas = extractJsonLd(html);

                if (schemas.length === 0) {
                    showNoData();
                } else {
                    displaySchemas(schemas, url);
                }
            } catch (error) {
                console.error('Error:', error);
                showError(`エラーが発生しました: ${error.message}\n\nCORSの制限により、一部のサイトからデータを取得できない場合があります。`);
            } finally {
                showLoading(false);
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function extractJsonLd(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const scripts = doc.querySelectorAll('script[type="application/ld+json"]');

            const schemas = [];
            scripts.forEach(script => {
                try {
                    const json = JSON.parse(script.textContent);
                    schemas.push(json);
                } catch (e) {
                    console.error('Failed to parse JSON-LD:', e);
                }
            });

            return schemas;
        }

        function displaySchemas(schemas, url) {
            const container = document.getElementById('schemasContainer');
            const statsContainer = document.getElementById('stats');

            // 統計情報を表示
            const totalProperties = schemas.reduce((acc, schema) => {
                return acc + countProperties(schema);
            }, 0);

            statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">スキーマ数</span>
                    <span class="stat-value">${schemas.length}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">プロパティ総数</span>
                    <span class="stat-value">${totalProperties}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ドメイン</span>
                    <span class="stat-value">${new URL(url).hostname}</span>
                </div>
            `;

            container.innerHTML = '';

            schemas.forEach((schema, index) => {
                const card = createSchemaCard(schema, index + 1);
                container.appendChild(card);
            });

            showResults();
        }

        function countProperties(obj) {
            if (typeof obj !== 'object' || obj === null) return 0;

            let count = 0;
            for (let key in obj) {
                count++;
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    count += countProperties(obj[key]);
                }
            }
            return count;
        }

        function createSchemaCard(schema, index) {
            const card = document.createElement('div');
            card.className = 'schema-card';

            const type = getSchemaType(schema);
            const id = `schema-${index}`;

            card.innerHTML = `
                <div class="schema-header">
                    <div>
                        <span class="schema-type">${type}</span>
                        <span class="schema-index">Schema #${index}</span>
                    </div>
                    <div class="schema-controls">
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('${id}', 'table', this)">テーブル</button>
                            <button onclick="toggleView('${id}', 'json', this)">JSON</button>
                        </div>
                        <button class="copy-button" onclick="copyToClipboard('${id}', this)">
                            コピー
                        </button>
                    </div>
                </div>
                <div class="schema-content" id="${id}" data-raw='${JSON.stringify(schema)}'>
                    <div class="table-view" id="${id}-table">
                        ${createTableView(schema)}
                    </div>
                    <div class="json-view hidden" id="${id}-json">
                        ${formatJson(schema)}
                    </div>
                </div>
            `;

            return card;
        }

        function toggleView(schemaId, view, button) {
            const tableView = document.getElementById(`${schemaId}-table`);
            const jsonView = document.getElementById(`${schemaId}-json`);
            const toggleButtons = button.parentElement.querySelectorAll('button');

            toggleButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            if (view === 'table') {
                tableView.classList.remove('hidden');
                jsonView.classList.add('hidden');
            } else {
                jsonView.classList.remove('hidden');
                tableView.classList.add('hidden');
            }
        }

        function createTableView(obj, depth = 0) {
            if (Array.isArray(obj)) {
                return createArrayView(obj, depth);
            }

            if (typeof obj === 'object' && obj !== null) {
                return createObjectTable(obj, depth);
            }

            return formatValue(obj);
        }

        function createObjectTable(obj, depth) {
            const entries = Object.entries(obj);

            if (entries.length === 0) return '<span class="property-value">空のオブジェクト</span>';

            let html = '<table class="data-table">';
            html += '<thead><tr><th>プロパティ</th><th>値</th><th>型</th></tr></thead>';
            html += '<tbody>';

            entries.forEach(([key, value]) => {
                const type = getValueType(value);
                html += '<tr>';
                html += `<td class="property-name">${escapeHtml(key)}</td>`;
                html += '<td>';

                if (typeof value === 'object' && value !== null) {
                    if (Array.isArray(value)) {
                        html += createArrayView(value, depth + 1);
                    } else {
                        html += createNestedObjectView(value, depth + 1);
                    }
                } else {
                    html += formatValue(value, key);
                }

                html += '</td>';
                html += `<td><span class="property-type">${type}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function createArrayView(arr, depth) {
            if (arr.length === 0) return '<span class="property-value">空の配列</span>';

            let html = `<div class="array-list">`;
            html += `<div style="margin-bottom: 8px; color: #64748b; font-size: 13px;">配列 (${arr.length}項目)</div>`;

            arr.forEach((item, index) => {
                html += `<div class="array-list-item">`;
                html += `<strong style="color: #64748b; font-size: 12px;">Item ${index + 1}</strong>`;

                if (typeof item === 'object' && item !== null) {
                    html += `<div style="margin-top: 8px;">`;
                    html += createTableView(item, depth + 1);
                    html += `</div>`;
                } else {
                    html += `: ${formatValue(item, null)}`;
                }

                html += `</div>`;
            });

            html += `</div>`;
            return html;
        }

        function createNestedObjectView(obj, depth) {
            const id = `nested-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const entries = Object.entries(obj);

            if (entries.length === 0) return '<span class="property-value">空のオブジェクト</span>';

            let preview = entries.slice(0, 3).map(([k, v]) => {
                const val = typeof v === 'object' ? '...' : formatSimpleValue(v);
                return `${k}: ${val}`;
            }).join(', ');

            if (entries.length > 3) preview += '...';

            let html = `
                <div>
                    <span class="expandable" onclick="toggleNested('${id}', this)">
                        オブジェクト {${preview}}
                    </span>
                    <div class="nested-content" id="${id}">
                        <div class="nested-object">
                            ${createTableView(obj, depth)}
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function toggleNested(id, element) {
            const content = document.getElementById(id);
            element.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        function formatValue(value, key) {
            if (value === null) return '<span class="property-value">null</span>';
            if (value === undefined) return '<span class="property-value">undefined</span>';

            if (typeof value === 'string') {
                // URLの判定と処理
                if (value.match(/^https?:\/\//)) {
                    return `<a href="${escapeHtml(value)}" target="_blank" class="url-value">${escapeHtml(value)}</a>`;
                }

                // descriptionフィールドの場合はHTMLとして処理
                if (key && key.toLowerCase() === 'description') {
                    // HTMLタグを含む場合はそのまま表示（危険なタグは除去）
                    const sanitized = value
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // scriptタグ除去
                        .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '') // styleタグ除去
                        .replace(/on\w+\s*=\s*"[^"]*"/gi, '') // イベントハンドラ除去
                        .replace(/on\w+\s*=\s*'[^']*'/gi, ''); // イベントハンドラ除去

                    return `<span class="property-value">${sanitized}</span>`;
                }

                return `<span class="property-value">${escapeHtml(value)}</span>`;
            }

            if (typeof value === 'boolean') {
                return `<span class="property-value" style="color: #dc2626;">${value}</span>`;
            }

            if (typeof value === 'number') {
                return `<span class="property-value" style="color: #ea580c;">${value}</span>`;
            }

            return `<span class="property-value">${escapeHtml(String(value))}</span>`;
        }

        function formatSimpleValue(value) {
            if (value === null) return 'null';
            if (value === undefined) return 'undefined';
            if (typeof value === 'string') return value.length > 20 ? value.substr(0, 20) + '...' : value;
            return String(value);
        }

        function getValueType(value) {
            if (value === null) return 'null';
            if (Array.isArray(value)) return 'array';
            return typeof value;
        }

        function getSchemaType(schema) {
            if (Array.isArray(schema)) {
                return 'Array';
            }
            if (schema['@type']) {
                if (Array.isArray(schema['@type'])) {
                    return schema['@type'].join(', ');
                }
                return schema['@type'];
            }
            if (schema['@graph']) {
                return '@graph';
            }
            return 'Object';
        }

        function formatJson(obj, indent = 0) {
            const spaces = '  '.repeat(indent);

            if (obj === null) {
                return `<span class="json-null">null</span>`;
            }

            if (typeof obj === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }

            if (typeof obj === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }

            if (typeof obj === 'string') {
                return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            }

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '<span class="json-bracket">[]</span>';
                let result = '<span class="json-bracket">[</span>\n';
                obj.forEach((item, i) => {
                    result += spaces + '  ' + formatJson(item, indent + 1);
                    if (i < obj.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '<span class="json-bracket">]</span>';
                return result;
            }

            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span class="json-bracket">{}</span>';
                let result = '<span class="json-bracket">{</span>\n';
                keys.forEach((key, i) => {
                    result += spaces + '  ' + `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                    result += formatJson(obj[key], indent + 1);
                    if (i < keys.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '<span class="json-bracket">}</span>';
                return result;
            }

            return String(obj);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        async function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const rawData = element.dataset.raw;

            try {
                const formatted = JSON.stringify(JSON.parse(rawData), null, 2);
                await navigator.clipboard.writeText(formatted);

                button.textContent = 'コピー完了';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'コピー';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                button.textContent = 'エラー';
                setTimeout(() => {
                    button.textContent = 'コピー';
                }, 2000);
            }
        }

        function showNoData() {
            const container = document.getElementById('schemasContainer');
            container.innerHTML = `
                <div class="no-data">
                    <h3>JSON-LDスキーマが見つかりませんでした</h3>
                    <p>このページには構造化データが含まれていないようです</p>
                </div>
            `;
            showResults();
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('fetchButton').disabled = show;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        function showResults() {
            document.getElementById('results').classList.add('active');
        }

        function hideResults() {
            document.getElementById('results').classList.remove('active');
        }

        // Enterキーでの送信に対応
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchAndDisplay();
            }
        });
    </script>
</body>
</html>