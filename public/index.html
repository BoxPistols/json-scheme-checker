<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-LD Schema Viewer (Proxy Version)</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>JSON-LD Schema Viewer</h1>
            <p class="subtitle">Node.jsプロキシサーバー版 - localhost対応</p>
            <span class="server-status" id="serverStatus">サーバー確認中...</span>
            <span>
                <a class="doc-pill" target="_blank" rel="noopener noreferrer"
                    href="https://developers.google.com/search/docs/appearance/structured-data/job-posting?hl=ja">Google公式リファレンス</a>
            </span>
        </header>

        <div class="input-section">
            <div class="input-group">
                <input type="url" id="urlInput" placeholder="URLを入力してください (例: http://localhost:3002/foo/bars/12345)"
                    value="" style="flex: 1;">
                <input type="number" id="localhostPort" placeholder="port"
                    style="width: 80px; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;"
                    min="1" max="65535" value="3000">
                <button id="fetchButton" onclick="fetchAndDisplay()">
                    取得
                </button>
            </div>

            <details style="margin-bottom: 15px;" id="authSection">
                <summary style="cursor: pointer; color: #64748b; font-size: 14px; margin-bottom: 10px;">
                    Basic認証が必要な場合
                    <span id="authStatus" style="margin-left: 8px; font-size: 12px; color: #10b981;"></span>
                </summary>
                <div style="margin-top: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="text" id="username" placeholder="ユーザー名"
                            style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                        <div style="position: relative;">
                            <input type="password" id="password" placeholder="パスワード"
                                style="padding: 8px 40px 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; width: 100%;">
                            <button type="button" id="togglePassword" onclick="togglePasswordVisibility()"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; padding: 4px; cursor: pointer; color: #64748b;"
                                aria-label="パスワードを表示/非表示" title="パスワードを表示/非表示">
                                <span id="iconEye" aria-hidden="true" style="display:inline-flex;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" stroke="currentColor"
                                            stroke-width="2" fill="none" />
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"
                                            fill="none" />
                                    </svg>
                                </span>
                                <span id="iconEyeOff" aria-hidden="true" style="display:none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 3l18 18" stroke="currentColor" stroke-width="2" />
                                        <path
                                            d="M21 12s-4 7-9 7c-2.038 0-3.92-.8-5.5-1.9M3 12s4-7 9-7c2.051 0 3.936.808 5.517 1.913"
                                            stroke="currentColor" stroke-width="2" />
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #64748b;">
                            <input type="checkbox" id="rememberAuth" onchange="handleRememberAuth()"
                                style="width: 16px; height: 16px;">
                            <span>認証情報を記憶する（このブラウザのみ）</span>
                        </label>
                        <button type="button" onclick="clearAuth()"
                            style="margin-left: auto; padding: 4px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                            認証情報をクリア
                        </button>
                    </div>
                    <div
                        style="margin-top: 8px; padding: 10px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; font-size: 12px; color: #14532d; line-height: 1.6;">
                        <div style="display: flex; align-items: flex-start; gap: 6px;">
                            <span aria-hidden="true" style="display:inline-flex;align-items:center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" style="color:#166534">
                                    <rect x="4" y="10" width="16" height="10" rx="2" stroke="currentColor"
                                        stroke-width="2" />
                                    <path d="M8 10V7a4 4 0 1 1 8 0v3" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </span>
                            <div>
                                <strong style="color: #166534;">完全ローカル保存・プライバシー重視</strong><br>
                                • 入力された認証情報は<strong>このブラウザのみに保存</strong>されます<br>
                                • <strong>サーバーへの送信・記録は一切行いません</strong><br>
                                • 開発者も含め、誰もあなたの認証情報にアクセスできません<br>
                                • ブラウザのローカルストレージを使用（Cookieより安全）
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <div class="sample-links">
                <span>サンプル:</span>
                <a class="sample-link"
                    onclick="loadSample('https://freelance-hub.jp/project/detail/281563/')">freelance-hub</a>
                <a class="sample-link"
                    onclick="loadSample('https://freelance.levtech.jp/project/detail/28421/')">levtech</a>
                <a class="sample-link" onclick="loadSample('https://freelance-job.com/job/detail/146243')">freelance-job
                </a>
                <a class="sample-link"
                    onclick="loadSample('https://www.r-agent.com/kensaku/kyujin/20250107-188-01-052.html')">RecruitAgent
                </a>
                <a class="sample-link" onclick="loadSample('https://pe-bank.jp/project/aws/47302-18/')">PE-BANK</a>
                </a>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>データを取得中...</p>
            </div>

            <div class="results-section" id="results">
                <div class="stats" id="stats"></div>
                <div id="schemasContainer"></div>
            </div>
        </div>

        <script>
            // プロキシサーバーのURL設定
            // Vercelデプロイメントか、ローカル開発かを自動判定
            const currentHost = window.location.hostname;
            const isVercel = currentHost.includes('vercel.app') || currentHost.includes('vercel.sh');
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            // 環境に応じたプロキシサーバーURL
            let PROXY_SERVER;
            if (isVercel) {
                // Vercel環境: API Routes を使用
                PROXY_SERVER = '';  // 相対パスでAPIを呼び出す
            } else if (isLocalhost) {
                // ローカル開発: localhost:3333
                PROXY_SERVER = 'http://localhost:3333';
            } else {
                // LAN内の他デバイス: IPアドレス:3333
                PROXY_SERVER = `http://${currentHost}:3333`;
            }

            console.log('Environment:', isVercel ? 'Vercel' : 'Local', 'Proxy:', PROXY_SERVER || 'API Routes');

            // パスワードの表示/非表示を切り替え
            function togglePasswordVisibility() {
                const passwordField = document.getElementById('password');
                const toggleButton = document.getElementById('togglePassword');
                const iconEye = document.getElementById('iconEye');
                const iconEyeOff = document.getElementById('iconEyeOff');

                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    if (iconEye && iconEyeOff) {
                        iconEye.style.display = 'none';
                        iconEyeOff.style.display = 'inline-flex';
                    }
                    toggleButton.title = 'パスワードを非表示';
                } else {
                    passwordField.type = 'password';
                    if (iconEye && iconEyeOff) {
                        iconEye.style.display = 'inline-flex';
                        iconEyeOff.style.display = 'none';
                    }
                    toggleButton.title = 'パスワードを表示';
                }
            }

            // 認証情報の管理
            const AUTH_STORAGE_KEY = 'jsonld_basic_auth';
            const DOMAIN_AUTH_PREFIX = 'jsonld_auth_';

            // ページ読み込み時に保存された認証情報を復元
            function loadStoredAuth() {
                const stored = localStorage.getItem(AUTH_STORAGE_KEY);
                if (stored) {
                    try {
                        const auth = JSON.parse(stored);
                        document.getElementById('username').value = auth.username || '';
                        document.getElementById('password').value = auth.password || '';
                        document.getElementById('rememberAuth').checked = true;
                        updateAuthStatus(true);
                    } catch (e) {
                        console.error('Failed to load stored auth:', e);
                    }
                }
            }

            // 認証情報の記憶/解除を処理
            function handleRememberAuth() {
                const remember = document.getElementById('rememberAuth').checked;
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (remember) {
                    if (username || password) {
                        // 認証情報を保存
                        const auth = { username, password, timestamp: Date.now() };
                        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(auth));
                        updateAuthStatus(true);
                    }
                } else {
                    // 認証情報を削除
                    localStorage.removeItem(AUTH_STORAGE_KEY);
                    updateAuthStatus(false);
                }
            }

            // 認証情報をクリア
            function clearAuth() {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('rememberAuth').checked = false;

                // グローバル認証情報を削除
                localStorage.removeItem(AUTH_STORAGE_KEY);

                // ドメイン別の認証情報もすべて削除
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(DOMAIN_AUTH_PREFIX)) {
                        localStorage.removeItem(key);
                    }
                });

                updateAuthStatus(false);
                showMessage('すべての認証情報をクリアしました', 'success');
            }

            // 認証状態の表示を更新
            function updateAuthStatus(isStored) {
                const statusEl = document.getElementById('authStatus');
                if (isStored) {
                    statusEl.textContent = '(保存済み)';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = '';
                }
            }

            // メッセージ表示用のヘルパー関数
            function showMessage(message, type = 'info') {
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = message;
                errorEl.style.background = type === 'success' ? '#d1fae5' : '#fef2f2';
                errorEl.style.borderColor = type === 'success' ? '#86efac' : '#fecaca';
                errorEl.style.color = type === 'success' ? '#065f46' : '#dc2626';
                errorEl.classList.add('active');

                // 3秒後に自動的に非表示
                setTimeout(() => {
                    errorEl.classList.remove('active');
                }, 3000);
            }

            // サーバーステータスをチェック
            async function checkServerStatus() {
                const statusElement = document.getElementById('serverStatus');
                try {
                    // Vercel環境では /api/health、ローカルでは /health
                    const healthUrl = isVercel ? '/api/health' : `${PROXY_SERVER}/health`;
                    const response = await fetch(healthUrl);
                    if (response.ok) {
                        statusElement.textContent = isVercel ? 'Vercel API稼働中' : 'サーバー稼働中';
                        statusElement.className = 'server-status';
                        return true;
                    }
                } catch (error) {
                    statusElement.textContent = isVercel ? 'API エラー' : 'サーバーオフライン';
                    statusElement.className = 'server-status offline';
                    return false;
                }
            }

            // 初期化時にサーバー状態をチェックと認証情報を復元
            checkServerStatus();
            loadStoredAuth();

            // URLに基づいて認証情報を自動入力
            function autoFillAuthForUrl(url) {
                try {
                    const urlObj = new URL(url);
                    const domainKey = DOMAIN_AUTH_PREFIX + urlObj.hostname;
                    const domainAuth = localStorage.getItem(domainKey);

                    if (domainAuth) {
                        const auth = JSON.parse(domainAuth);
                        document.getElementById('username').value = auth.username || '';
                        document.getElementById('password').value = auth.password || '';
                        showMessage(`${urlObj.hostname}の認証情報を自動入力しました`, 'success');

                        // authセクションを自動展開
                        const authSection = document.getElementById('authSection');
                        if (authSection) {
                            authSection.open = true;
                        }
                        return true;
                    }
                } catch (e) {
                    console.log('Could not auto-fill auth:', e);
                }
                return false;
            }

            function loadSample(url) {
                document.getElementById('urlInput').value = url;
                autoFillAuthForUrl(url);
                fetchAndDisplay();
            }

            async function fetchAndDisplay() {
                const urlInput = document.getElementById('urlInput');
                let url = urlInput.value.trim();

                if (!url) {
                    showError('URLを入力してください');
                    return;
                }

                if (!isValidUrl(url)) {
                    showError('有効なURLを入力してください');
                    return;
                }

                // localhostのURLの場合、ポート番号を自動置換
                const customPort = document.getElementById('localhostPort').value;
                if (customPort) {
                    try {
                        const urlObj = new URL(url);
                        if (urlObj.hostname === 'localhost' || urlObj.hostname === '127.0.0.1') {
                            urlObj.port = customPort;
                            url = urlObj.toString();
                            console.log('Adjusted localhost URL to:', url);
                        }
                    } catch (e) {
                        console.error('Could not parse URL for port adjustment:', e);
                    }
                }

                // サーバー状態を再チェック
                const serverOnline = await checkServerStatus();
                if (!serverOnline) {
                    if (isVercel) {
                        showError('Vercel APIに接続できません。しばらくお待ちください。');
                    } else {
                        showError('プロキシサーバーがオフラインです。"npm install && npm start" を実行してください。');
                    }
                    return;
                }

                showLoading(true);
                hideError();
                hideResults();

                try {
                    // Basic認証の情報を取得
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    const remember = document.getElementById('rememberAuth').checked;

                    // 記憶するオプションが有効で、認証情報がある場合は保存
                    if (remember && (username || password)) {
                        const auth = { username, password, timestamp: Date.now() };
                        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(auth));

                        // ドメインごとにも保存
                        try {
                            const urlObj = new URL(url);
                            const domainKey = DOMAIN_AUTH_PREFIX + urlObj.hostname;
                            localStorage.setItem(domainKey, JSON.stringify(auth));
                        } catch (e) {
                            console.log('Could not save domain-specific auth');
                        }

                        updateAuthStatus(true);
                    }

                    // プロキシサーバー経由でデータを取得
                    let proxyUrl;
                    if (isVercel) {
                        // Vercel環境: /api/proxy エンドポイントを使用
                        proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
                    } else {
                        // ローカル環境: 従来のプロキシサーバーを使用
                        proxyUrl = `${PROXY_SERVER}/proxy?url=${encodeURIComponent(url)}`;
                    }

                    if (username && password) {
                        proxyUrl += `&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
                    }

                    const response = await fetch(proxyUrl);

                    if (!response.ok) {
                        let errorMessage;
                        const contentType = response.headers.get('content-type');

                        if (contentType && contentType.includes('application/json')) {
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.message || errorData.error || `HTTPエラー ${response.status}`;
                            } catch {
                                errorMessage = await response.text();
                            }
                        } else {
                            errorMessage = await response.text();
                        }

                        // 401エラーの場合は明確なメッセージを表示
                        if (response.status === 401) {
                            throw new Error('Basic認証が失敗しました。ユーザー名とパスワードを確認してください。');
                        }

                        throw new Error(errorMessage);
                    }

                    const html = await response.text();
                    const schemas = extractJsonLd(html);

                    if (schemas.length === 0) {
                        showNoData();
                    } else {
                        displaySchemas(schemas, url);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError(`エラーが発生しました: ${error.message}`);
                } finally {
                    showLoading(false);
                }
            }

            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            function extractJsonLd(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scripts = doc.querySelectorAll('script[type="application/ld+json"]');

                const schemas = [];
                scripts.forEach(script => {
                    try {
                        const json = JSON.parse(script.textContent);
                        schemas.push(json);
                    } catch (e) {
                        console.error('Failed to parse JSON-LD:', e);
                    }
                });

                return schemas;
            }

            function displaySchemas(schemas, url) {
                const container = document.getElementById('schemasContainer');
                const statsContainer = document.getElementById('stats');

                const totalProperties = schemas.reduce((acc, schema) => {
                    return acc + countProperties(schema);
                }, 0);

                statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">スキーマ数</span>
                    <span class="stat-value">${schemas.length}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">プロパティ総数</span>
                    <span class="stat-value">${totalProperties}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ドメイン</span>
                    <span class="stat-value">${new URL(url).hostname}</span>
                </div>
            `;

                container.innerHTML = '';

                schemas.forEach((schema, index) => {
                    const card = createSchemaCard(schema, index + 1);
                    container.appendChild(card);
                });

                showResults();
            }

            function countProperties(obj) {
                if (typeof obj !== 'object' || obj === null) return 0;

                let count = 0;
                for (let key in obj) {
                    count++;
                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                        count += countProperties(obj[key]);
                    }
                }
                return count;
            }

            function createSchemaCard(schema, index) {
                const card = document.createElement('div');
                card.className = 'schema-card';

                const type = getSchemaType(schema);
                const id = `schema-${index}`;

                card.innerHTML = `
                <div class="schema-header">
                    <div>
                        <span class="schema-type">${type}</span>
                        <span class="schema-index">Schema #${index}</span>
                    </div>
                    <div class="schema-controls">
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('${id}', 'table', this)">テーブル</button>
                            <button onclick="toggleView('${id}', 'json', this)">JSON</button>
                        </div>
                        <div class="doc-links">${buildDocLinks(schema)}</div>
                        <button class="copy-button" onclick="copyToClipboard('${id}', this)">
                            コピー
                        </button>
                    </div>
                </div>
                <div class="schema-content" id="${id}" data-raw='${JSON.stringify(schema)}'>
                    <div class="table-view" id="${id}-table">
                        ${createTableView(schema)}
                    </div>
                    <div class="json-view hidden" id="${id}-json">
                        ${formatJson(schema)}
                    </div>
                </div>
            `;

                return card;
            }

            function toggleView(schemaId, view, button) {
                const tableView = document.getElementById(`${schemaId}-table`);
                const jsonView = document.getElementById(`${schemaId}-json`);
                const toggleButtons = button.parentElement.querySelectorAll('button');

                toggleButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                if (view === 'table') {
                    tableView.classList.remove('hidden');
                    jsonView.classList.add('hidden');
                } else {
                    jsonView.classList.remove('hidden');
                    tableView.classList.add('hidden');
                }
            }

            function createTableView(obj, depth = 0) {
                if (Array.isArray(obj)) {
                    return createArrayView(obj, depth);
                }

                if (typeof obj === 'object' && obj !== null) {
                    return createObjectTable(obj, depth);
                }

                return formatValue(obj);
            }

            function createObjectTable(obj, depth) {
                const entries = Object.entries(obj);

                if (entries.length === 0) return '<span class="property-value">空のオブジェクト</span>';

                let html = '<table class="data-table"><colgroup><col class="col-prop"><col class="col-value"><col class="col-type"></colgroup>';
                html += '<thead><tr><th>プロパティ</th><th>値</th><th>型</th></tr></thead>';
                html += '<tbody>';

                entries.forEach(([key, value]) => {
                    const type = getValueType(value);
                    html += '<tr>';
                    html += `<td class="property-name">${escapeHtml(key)}</td>`;
                    html += '<td>';

                    if (typeof value === 'object' && value !== null) {
                        if (Array.isArray(value)) {
                            html += createArrayView(value, depth + 1);
                        } else {
                            html += createNestedObjectView(value, depth + 1);
                        }
                    } else {
                        html += formatValue(value, key);
                    }

                    html += '</td>';
                    html += `<td><span class="property-type">${type}</span></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            function createArrayView(arr, depth) {
                if (arr.length === 0) return '<span class="property-value">空の配列</span>';

                let html = `<div class="array-list">`;
                html += `<div style="margin-bottom: 8px; color: #64748b; font-size: 13px;">配列 (${arr.length}項目)</div>`;

                arr.forEach((item, index) => {
                    html += `<div class="array-list-item">`;
                    html += `<strong style="color: #64748b; font-size: 12px;">Item ${index + 1}</strong>`;

                    if (typeof item === 'object' && item !== null) {
                        html += `<div style="margin-top: 8px;">`;
                        html += createTableView(item, depth + 1);
                        html += `</div>`;
                    } else {
                        html += `: ${formatValue(item)}`;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
                return html;
            }

            function createNestedObjectView(obj, depth) {
                const id = `nested-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const entries = Object.entries(obj);

                if (entries.length === 0) return '<span class="property-value">空のオブジェクト</span>';

                let preview = entries.slice(0, 3).map(([k, v]) => {
                    const val = typeof v === 'object' ? '...' : formatSimpleValue(v);
                    return `${k}: ${val}`;
                }).join(', ');

                if (entries.length > 3) preview += '...';

                let html = `
                <div>
                    <span class="expandable" onclick="toggleNested('${id}', this)">
                        オブジェクト {${preview}}
                    </span>
                    <div class="nested-content" id="${id}">
                        <div class="nested-object">
                            <div class="table-view">${createTableView(obj, depth)}</div>
                        </div>
                    </div>
                </div>
            `;

                return html;
            }

            function toggleNested(id, element) {
                const content = document.getElementById(id);
                element.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }

            function formatValue(value, key) {
                if (value === null) return '<span class="property-value">null</span>';
                if (value === undefined) return '<span class="property-value">undefined</span>';

                if (typeof value === 'string') {
                    // descriptionなど、<br> が含まれる文字列は意図した改行を反映
                    if (hasHtmlBr(value) || (key && key.toLowerCase() === 'description')) {
                        const escaped = escapeHtml(value);
                        const withBreaks = escaped.replace(/&lt;br\s*\/?&gt;/gi, '<br>');
                        return `<span class="property-value">${withBreaks}</span>`;
                    }
                    if (value.match(/^https?:\/\//)) {
                        // 画像URLはサムネイル付きで表示
                        if (isImageUrl(value)) {
                            const safe = escapeHtml(value);
                            return `
                            <span class="image-value">
                                <img src="${safe}" alt="image" class="image-thumb" loading="lazy" referrerpolicy="no-referrer" />
                                <a href="${safe}" target="_blank" class="url-value">${safe}</a>
                            </span>
                        `;
                        }
                        return `<a href="${escapeHtml(value)}" target="_blank" class="url-value">${escapeHtml(value)}</a>`;
                    }
                    return `<span class="property-value">${escapeHtml(value)}</span>`;
                }

                if (typeof value === 'boolean') {
                    return `<span class="property-value" style="color: #dc2626;">${value}</span>`;
                }

                if (typeof value === 'number') {
                    return `<span class="property-value" style="color: #ea580c;">${value}</span>`;
                }

                return `<span class="property-value">${escapeHtml(String(value))}</span>`;
            }

            function isImageUrl(url) {
                try {
                    const u = new URL(url);
                    const pathname = u.pathname.toLowerCase();
                    return pathname.match(/\.(png|jpe?g|gif|webp|svg)$/);
                } catch (_) {
                    return false;
                }
            }

            // スキーマタイプごとのドキュメントリンク生成
            function buildDocLinks(schema) {
                const googleDocsMap = {
                    JobPosting: 'https://developers.google.com/search/docs/appearance/structured-data/job-posting?hl=ja',
                    Article: 'https://developers.google.com/search/docs/appearance/structured-data/article?hl=ja',
                    BreadcrumbList: 'https://developers.google.com/search/docs/appearance/structured-data/breadcrumb?hl=ja',
                    Product: 'https://developers.google.com/search/docs/appearance/structured-data/product?hl=ja',
                    FAQPage: 'https://developers.google.com/search/docs/appearance/structured-data/faqpage?hl=ja',
                    HowTo: 'https://developers.google.com/search/docs/appearance/structured-data/how-to?hl=ja',
                    Event: 'https://developers.google.com/search/docs/appearance/structured-data/event?hl=ja',
                    LocalBusiness: 'https://developers.google.com/search/docs/appearance/structured-data/local-business?hl=ja',
                    Organization: 'https://developers.google.com/search/docs/appearance/structured-data/logo?hl=ja',
                    WebSite: 'https://developers.google.com/search/docs/appearance/structured-data/sitelinks-searchbox?hl=ja',
                    VideoObject: 'https://developers.google.com/search/docs/appearance/structured-data/video?hl=ja',
                    Recipe: 'https://developers.google.com/search/docs/appearance/structured-data/recipe?hl=ja'
                };

                let types = [];
                if (schema && schema['@type']) {
                    types = Array.isArray(schema['@type']) ? schema['@type'] : [schema['@type']];
                } else if (schema && schema['@graph']) {
                    // @graphの場合、代表的な@typeを抽出
                    try {
                        const graph = Array.isArray(schema['@graph']) ? schema['@graph'] : [];
                        types = [...new Set(graph.map(n => n['@type']).filter(Boolean))].slice(0, 2);
                    } catch (_) { /* noop */ }
                }

                if (types.length === 0) return '';

                const pills = types.slice(0, 2).map(t => {
                    const sUrl = `https://schema.org/${encodeURIComponent(t)}`;
                    const gUrl = googleDocsMap[t];
                    const schemaLink = `<a class="doc-pill" target="_blank" rel="noopener noreferrer" href="${sUrl}">schema.org/${t}</a>`;
                    const googleLink = gUrl ? `<a class=\"doc-pill\" target=\"_blank\" rel=\"noopener noreferrer\" href=\"${gUrl}\">Google ${t}</a>` : '';
                    return [schemaLink, googleLink].filter(Boolean).join('');
                }).join('');

                return pills;
            }

            function hasHtmlBr(text) {
                return /<br\s*\/?\s*>/i.test(text);
            }

            function formatSimpleValue(value) {
                if (value === null) return 'null';
                if (value === undefined) return 'undefined';
                if (typeof value === 'string') return value.length > 20 ? value.substr(0, 20) + '...' : value;
                return String(value);
            }

            function getValueType(value) {
                if (value === null) return 'null';
                if (Array.isArray(value)) return 'array';
                return typeof value;
            }

            function getSchemaType(schema) {
                if (Array.isArray(schema)) {
                    return 'Array';
                }
                if (schema['@type']) {
                    if (Array.isArray(schema['@type'])) {
                        return schema['@type'].join(', ');
                    }
                    return schema['@type'];
                }
                if (schema['@graph']) {
                    return '@graph';
                }
                return 'Object';
            }

            function formatJson(obj, indent = 0) {
                const spaces = '  '.repeat(indent);

                if (obj === null) {
                    return `<span class="json-null">null</span>`;
                }

                if (typeof obj === 'boolean') {
                    return `<span class="json-boolean">${obj}</span>`;
                }

                if (typeof obj === 'number') {
                    return `<span class="json-number">${obj}</span>`;
                }

                if (typeof obj === 'string') {
                    return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
                }

                if (Array.isArray(obj)) {
                    if (obj.length === 0) return '<span class="json-bracket">[]</span>';
                    let result = '<span class="json-bracket">[</span>\n';
                    obj.forEach((item, i) => {
                        result += spaces + '  ' + formatJson(item, indent + 1);
                        if (i < obj.length - 1) result += ',';
                        result += '\n';
                    });
                    result += spaces + '<span class="json-bracket">]</span>';
                    return result;
                }

                if (typeof obj === 'object') {
                    const keys = Object.keys(obj);
                    if (keys.length === 0) return '<span class="json-bracket">{}</span>';
                    let result = '<span class="json-bracket">{</span>\n';
                    keys.forEach((key, i) => {
                        result += spaces + '  ' + `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                        result += formatJson(obj[key], indent + 1);
                        if (i < keys.length - 1) result += ',';
                        result += '\n';
                    });
                    result += spaces + '<span class="json-bracket">}</span>';
                    return result;
                }

                return String(obj);
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }

            async function copyToClipboard(elementId, button) {
                const element = document.getElementById(elementId);
                const rawData = element.dataset.raw;

                try {
                    const formatted = JSON.stringify(JSON.parse(rawData), null, 2);
                    await navigator.clipboard.writeText(formatted);

                    button.textContent = 'コピー完了';
                    button.classList.add('copied');

                    setTimeout(() => {
                        button.textContent = 'コピー';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    button.textContent = 'エラー';
                    setTimeout(() => {
                        button.textContent = 'コピー';
                    }, 2000);
                }
            }

            function showNoData() {
                const container = document.getElementById('schemasContainer');
                container.innerHTML = `
                <div class="no-data">
                    <h3>JSON-LDスキーマが見つかりませんでした</h3>
                    <p>このページには構造化データが含まれていないようです</p>
                </div>
            `;
                showResults();
            }

            function showLoading(show) {
                document.getElementById('loading').classList.toggle('active', show);
                document.getElementById('fetchButton').disabled = show;
            }

            function showError(message) {
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = message;
                // 明示的にエラーカラーへリセット（前回の成功スタイルが残らないように）
                errorEl.style.background = '#fef2f2';
                errorEl.style.borderColor = '#fecaca';
                errorEl.style.color = '#dc2626';
                errorEl.classList.add('active');
            }

            function hideError() {
                document.getElementById('errorMessage').classList.remove('active');
            }

            function showResults() {
                document.getElementById('results').classList.add('active');
            }

            function hideResults() {
                document.getElementById('results').classList.remove('active');
            }

            // Enterキーでの送信に対応
            document.getElementById('urlInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    fetchAndDisplay();
                }
            });

            // URLが変更されたときに認証情報を自動入力し、ポート番号を自動検出
            document.getElementById('urlInput').addEventListener('input', function (e) {
                const url = e.target.value.trim();
                if (url) {
                    // localhostのURLからポート番号を自動検出（入力時にリアルタイム更新）
                    try {
                        const urlObj = new URL(url);
                        if ((urlObj.hostname === 'localhost' || urlObj.hostname === '127.0.0.1' || urlObj.hostname === '[::1]') && urlObj.port) {
                            document.getElementById('localhostPort').value = urlObj.port;
                        }
                    } catch (e) {
                        console.error('Failed to parse URL for port detection:', e);
                    }
                }
            });

            document.getElementById('urlInput').addEventListener('blur', function (e) {
                const url = e.target.value.trim();
                if (url) {
                    autoFillAuthForUrl(url);
                }
            });
        </script>
        <script src="/app.js"></script>
</body>

</html>